<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PASE UTI DIGITAL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, orderBy, limit, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.fb = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, doc, setDoc, onSnapshot, collection, query, orderBy, limit, getDocs, deleteDoc };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #333333; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #E0E0E0; border-radius: 10px; }
        
        .bg-primary { background-color: #B11478; }
        .text-primary { color: #B11478; }
        .border-primary { border-color: #B11478; }
        .bg-light { background-color: #FCE4F1; }

        input, select, textarea { 
            font-size: 16px !important; 
            border-radius: 0.75rem !important; 
            outline: none; 
            border: 1px solid #E0E0E0; 
            color: #333333;
        }
        input:focus, select:focus, textarea:focus { 
            border-color: #B11478; 
            box-shadow: 0 0 0 3px rgba(177, 20, 120, 0.1);
        }
        
        #printable-content { display: none; }
        .pdf-section-title { font-size: 9px; font-weight: 900; text-transform: uppercase; color: #B11478; border-bottom: 1px solid #FCE4F1; margin-bottom: 4px; padding-bottom: 2px; }
        .pdf-label { font-size: 8px; font-weight: 700; color: #666; text-transform: uppercase; }
        .pdf-value { font-size: 9px; font-weight: 600; color: #333; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;
        
        const MockDB = {
            data: (() => {
                try {
                    const saved = localStorage.getItem('uti_handover_data');
                    return saved ? JSON.parse(saved) : {};
                } catch (e) { return {}; }
            })(),
            listeners: [],
            emit() { this.listeners.forEach(cb => cb(Object.values(this.data))); },
            subscribe(cb) { 
                this.listeners.push(cb); 
                cb(Object.values(this.data)); 
                return () => this.listeners = this.listeners.filter(l => l !== cb); 
            },
            update(id, newData) {
                this.data[id] = { ...this.data[id], ...newData, id };
                localStorage.setItem('uti_handover_data', JSON.stringify(this.data));
                this.emit();
            },
            delete(id) {
                delete this.data[id];
                localStorage.setItem('uti_handover_data', JSON.stringify(this.data));
                this.emit();
            }
        };

        const BED_OPTIONS = ["Cama 1", "Cama 2", "Cama 3", "Cama 4", "Cama 5", "Cama 6", "Cama 7", "Cama 8", "Cama 9", "Cama 10", "Shock Room", "Aislamiento"];
        const PHP_OPTIONS = ["11ml/h", "21ml/h", "42ml/h", "63ml/h", "84ml/h", "105ml/h", "126ml/h"];
        const INFUSION_DRUGS = [
            { group: "Vasoactivos", items: ["Noradrenalina 16mg", "Noradrenalina 32mg", "Nitroprusiato 50mg", "Nitroglicerina 50mg", "Vasopresina", "Dopamina", "Dobutamina", "Adrenalina"] },
            { group: "Sedoanalgesia", items: ["Midazolam", "Propofol", "Fentanilo", "Morfina", "Remifentanilo", "Atracurio"] },
            { group: "Otros", items: ["Furosemida", "Bicarbonato", "KCl", "Insulina", "Gluconato de Calcio"] }
        ];

        const getAutomaticShift = () => {
            const h = new Date().getHours();
            if (h >= 6 && h < 13) return "Turno Mañana";
            if (h >= 13 && h < 20) return "Turno Tarde";
            return "Turno Noche";
        };

        const Icon = ({ name, className = "w-5 h-5" }) => {
            const icons = {
                plus: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
                trash: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
                wind: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" /></svg>,
                zap: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>,
                shield: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A3.33 3.33 0 0018.377 2.866L12.04 1l-6.337 1.866a3.33 3.33 0 00-2.28 3.118 11.662 11.662 0 004.398 9.491 2.33 2.33 0 011.04 1.858V21h6.337v-3.667a2.33 2.33 0 011.04-1.858 11.662 11.662 0 004.398-9.491z" /></svg>,
                cloud: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" /></svg>,
                cog: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
                home: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>,
                download: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
            };
            return <div className={className}>{icons[name] || icons.plus}</div>;
        };

        const App = () => {
            const [patients, setPatients] = useState([]);
            const [currentView, setCurrentView] = useState('home'); 
            const [selectedId, setSelectedId] = useState(null);
            const [appMode, setAppMode] = useState('loading');
            const [fbServices, setFbServices] = useState(null);
            const [manualConfig, setManualConfig] = useState(localStorage.getItem('uti_fb_config') || '');
            const [showConfig, setShowConfig] = useState(false);

            // Inicializar Firebase
            useEffect(() => {
                const initFirebase = async () => {
                    if (window.fb && manualConfig) {
                        try {
                            const config = JSON.parse(manualConfig);
                            const { initializeApp, getAuth, signInAnonymously, getFirestore, collection, onSnapshot } = window.fb;
                            const app = initializeApp(config);
                            const auth = getAuth(app);
                            const db = getFirestore(app);
                            
                            await signInAnonymously(auth);
                            setFbServices({ ...window.fb, db });
                            setAppMode('firebase');

                            const q = collection(db, 'patients');
                            onSnapshot(q, (snap) => {
                                const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                                setPatients(data.sort((a,b) => a.bed.localeCompare(b.bed, undefined, {numeric: true})));
                            });
                        } catch (e) {
                            console.error("Error Firebase:", e);
                            setAppMode('offline');
                        }
                    } else {
                        setAppMode('offline');
                    }
                };
                initFirebase();
            }, [manualConfig]);

            useEffect(() => {
                if (appMode === 'offline') {
                    return MockDB.subscribe(data => {
                        setPatients(data.sort((a,b) => a.bed.localeCompare(b.bed, undefined, {numeric: true})));
                    });
                }
            }, [appMode]);

            const handleCreate = async (bed) => {
                const id = Date.now().toString();
                const newP = { bed, name: "", respiratory: { type: "AA" }, medication: { php: "21ml/h", infusions: [] }, notes: "" };
                if (appMode === 'firebase') {
                    await fbServices.setDoc(fbServices.doc(fbServices.db, 'patients', id), newP);
                } else {
                    MockDB.update(id, newP);
                }
                setSelectedId(id);
                setCurrentView('detail');
            };

            const saveConfig = () => {
                localStorage.setItem('uti_fb_config', manualConfig);
                window.location.reload();
            };

            return (
                <div className="flex h-screen bg-[#f8fafc]">
                    <aside className="w-20 bg-primary text-white flex flex-col items-center py-6 shadow-xl">
                        <div className="mb-10 font-black text-xl">UTI</div>
                        <button onClick={() => setCurrentView('home')} className={`p-4 rounded-2xl mb-4 ${currentView==='home'?'bg-white text-primary':'text-white/70'}`}><Icon name="home" /></button>
                        <button onClick={() => setShowConfig(true)} className={`p-4 rounded-2xl mt-auto ${appMode==='firebase'?'text-green-300':'text-white/40'}`}><Icon name="cloud" /></button>
                    </aside>

                    <main className="flex-1 overflow-y-auto p-8">
                        {currentView === 'home' ? (
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                {BED_OPTIONS.map(bed => {
                                    const p = patients.find(x => x.bed === bed);
                                    return (
                                        <button key={bed} onClick={() => p ? (setSelectedId(p.id), setCurrentView('detail')) : handleCreate(bed)}
                                            className={`h-32 p-4 rounded-3xl border-2 text-left flex flex-col justify-between transition-all ${p?'bg-primary border-primary text-white shadow-lg':'bg-white border-gray-100 text-gray-300'}`}>
                                            <span className="text-[10px] font-black uppercase">{bed}</span>
                                            <span className="font-bold uppercase truncate">{p ? p.name || "Ocupada" : "+ Vacía"}</span>
                                        </button>
                                    );
                                })}
                            </div>
                        ) : (
                            <div className="max-w-2xl mx-auto bg-white p-8 rounded-[2rem] shadow-sm border">
                                <button onClick={() => setCurrentView('home')} className="text-primary font-bold text-xs mb-4 uppercase">← Volver</button>
                                <h2 className="text-3xl font-black text-primary mb-6 uppercase">Detalle del Pase</h2>
                                <p className="text-gray-400 italic">Aquí podés editar la información del paciente...</p>
                                {/* Formulario abreviado para ejemplo */}
                                <div className="mt-6 space-y-4">
                                    <input className="w-full p-4 bg-gray-50 border-none" placeholder="Nombre del Paciente" 
                                        value={patients.find(x=>x.id===selectedId)?.name || ''} 
                                        onChange={(e) => {
                                            const id = selectedId;
                                            const val = e.target.value;
                                            if(appMode==='firebase') fbServices.setDoc(fbServices.doc(fbServices.db, 'patients', id), {name: val}, {merge:true});
                                            else MockDB.update(id, {name: val});
                                        }} />
                                    <textarea className="w-full p-4 bg-gray-50 border-none h-32" placeholder="Notas y pendientes..."
                                        value={patients.find(x=>x.id===selectedId)?.notes || ''}
                                        onChange={(e) => {
                                            const id = selectedId;
                                            const val = e.target.value;
                                            if(appMode==='firebase') fbServices.setDoc(fbServices.doc(fbServices.db, 'patients', id), {notes: val}, {merge:true});
                                            else MockDB.update(id, {notes: val});
                                        }} />
                                </div>
                            </div>
                        )}
                    </main>

                    {showConfig && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur flex items-center justify-center p-4 z-50">
                            <div className="bg-white p-8 rounded-3xl max-w-md w-full">
                                <h3 className="text-primary font-black mb-4">CONECTAR A LA NUBE</h3>
                                <textarea className="w-full h-48 p-4 text-xs font-mono border" placeholder='Pegá acá las llaves { ... }' value={manualConfig} onChange={e => setManualConfig(e.target.value)} />
                                <div className="flex gap-2 mt-4">
                                    <button onClick={() => setShowConfig(false)} className="flex-1 p-3 text-gray-400 font-bold">Cancelar</button>
                                    <button onClick={saveConfig} className="flex-1 p-3 bg-primary text-white rounded-xl font-bold">CONECTAR</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>