<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UTI DIGITAL GESTION IAF</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- HTML2PDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, query, getDocs, deleteDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.fb = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, onSnapshot, collection, addDoc, query, getDocs, deleteDoc, orderBy, limit, getDocs };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #333333; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #E0E0E0; border-radius: 10px; }
        
        /* IAF Colors */
        .bg-iaf-primary { background-color: #B11478; }
        .text-iaf-primary { color: #B11478; }
        .border-iaf-primary { border-color: #B11478; }
        
        .bg-iaf-light { background-color: #FCE4F1; }
        .text-iaf-light { color: #FCE4F1; }
        .border-iaf-light { border-color: #FCE4F1; }

        .text-iaf-dark { color: #333333; }
        .border-iaf-gray { border-color: #E0E0E0; }

        input, select, textarea { 
            font-size: 16px !important; 
            border-radius: 0.75rem !important; 
            outline: none; 
            border: 1px solid #E0E0E0; 
            color: #333333;
        }
        input:focus, select:focus, textarea:focus { 
            border-color: #B11478; 
            ring: 2px; 
            box-shadow: 0 0 0 3px rgba(177, 20, 120, 0.1);
        }
        input, textarea, select { touch-action: manipulation; }
        
        #printable-content { display: none; }
        
        /* PDF Styles */
        .pdf-section-title { font-size: 9px; font-weight: 900; text-transform: uppercase; color: #B11478; border-bottom: 1px solid #FCE4F1; margin-bottom: 4px; padding-bottom: 2px; }
        .pdf-label { font-size: 8px; font-weight: 700; color: #666; text-transform: uppercase; }
        .pdf-value { font-size: 9px; font-weight: 600; color: #333; }
        .pdf-tag { font-size: 8px; padding: 1px 4px; border-radius: 4px; font-weight: 700; display: inline-block; margin-right: 2px; margin-bottom: 2px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;
        
        // --- MOCK DATABASE ---
        const MockDB = {
            data: (() => {
                try {
                    const saved = localStorage.getItem('uti_handover_data');
                    return saved ? JSON.parse(saved) : {};
                } catch (e) { return {}; }
            })(),
            listeners: [],
            emit() { this.listeners.forEach(cb => cb(Object.values(this.data))); },
            subscribe(cb) { 
                this.listeners.push(cb); 
                cb(Object.values(this.data)); 
                return () => this.listeners = this.listeners.filter(l => l !== cb); 
            },
            update(id, newData) {
                this.data[id] = { ...this.data[id], ...newData, id };
                try { localStorage.setItem('uti_handover_data', JSON.stringify(this.data)); } catch (e) {}
                this.emit();
            },
            delete(id) {
                delete this.data[id];
                try { localStorage.setItem('uti_handover_data', JSON.stringify(this.data)); } catch (e) {}
                this.emit();
            }
        };

        // --- CONSTANTES ---
        const BED_OPTIONS = ["Cama 1", "Cama 2", "Cama 3", "Cama 4", "Cama 5", "Cama 6", "Cama 7", "Cama 8", "Cama 9", "Cama 10", "Shock Room", "Aislamiento"];
        const PHP_OPTIONS = ["11ml/h", "21ml/h", "42ml/h", "63ml/h", "84ml/h", "105ml/h", "126ml/h"];
        const ENTERAL_FLOW = ["21ml/h", "42ml/h", "63ml/h", "84ml/h"];
        
        const INFUSION_DRUGS = [
            { group: "Vasoactivos", items: ["Noradrenalina 16mg", "Noradrenalina 32mg", "Nitroprusiato 50mg", "Nitroglicerina 50mg", "Vasopresina", "Dopamina", "Dobutamina", "Adrenalina", "Milrinona", "Amiodarona"] },
            { group: "Sedoanalgesia", items: ["Midazolam", "Propofol", "Fentanilo", "Morfina", "Diclofenac", "Bupivaca√≠na", "Remifentanilo", "Atracurio"] },
            { group: "Otros", items: ["Furosemida 100mg", "Furosemida 200mg", "Furosemida 500mg", "Furosemida 1gr", "Bicarbonato 1M", "Bicarbonato 1/6", "Magnesio", "KCl", "Insulina", "Gluconato de Calcio", "Hidrocortisona"] }
        ];

        const ATB_LIST = ["Amikacina", "Ampicilina Sulbactam", "Anfotericina B", "Azitromicina", "Caspofungina", "Cefepime", "Ceftazidima Avibactam", "Ceftolozano Tazobactam", "Ceftriaxona", "Colistin", "Cotrimoxazol", "Fluconazol", "Fosfomicina", "Gentamicina", "Imipenem", "Linezolid", "Meropenem", "Metronidazol", "Piper Tazo", "Tigeciclina", "Vancomicina", "Voriconazol"];
        
        const DRAIN_TYPES = ["Drenaje 1", "Drenaje 2", "Drenaje 3", "Kher", "Pleural", "Abdominal", "Sonda Nasog√°strica", "Sonda Yeyunal", "Otros"];
        const DRAIN_CHARS = ["Hem√°tico", "Seroso", "Serohem√°tico", "Fecaloide", "Bilioso", "Purulento", "Limpio"];
        const RESP_DEVICES = ["AA", "C√°nula Nasal", "M√°scara Simple", "M√°scara Reservorio", "Alto Flujo", "VNI", "ARM"];
        const ARM_MODES = ["VC", "PC", "PS", "CPAP", "SIMV"];
        const DIET = ["NVO", "VO", "K108", "Gastrostom√≠a", "Yeyunostom√≠a", "NPT"];
        const DIURESIS_METHODS = ["Espont√°nea", "Sonda Vesical", "Nefrostom√≠a", "Bricker", "Ureterostom√≠a"];
        const DIURESIS_CHARS = ["Normal", "Conservada", "Concentrada", "Col√∫rica", "Hemat√∫rica", "Anuria"];
        const CATARSIS_STATUS = ["Positiva", "Negativa"];
        const CATARSIS_CHARS = ["Normal", "Blanda", "Normal Blanda", "Diarreica", "Melena"];
        const CULTURE_TYPES = ["HMC x 2", "HMC x 4", "Retrocultivo", "Urocultivo", "MiniBAL", "BAL", "Punta de Cat√©ter", "LCR", "L√≠quido Pleural", "Hisopado Rectal", "Hisopado Nasal", "Muestra Quir√∫rgica"];
        const ISOLATION_TYPES = ["No", "Contacto", "Respiratorio", "Gotitas", "Protector/Neutrop√©nico", "Cohorte"];
        const VASCULAR_TYPES = ["AVC (Venoso Central)", "Arterial", "Cat√©ter Cook", "AVP (Perif√©rico)", "Portal", "PICC"];
        const VASCULAR_SITES = ["Yugular Der (YD)", "Yugular Izq (YI)", "Femoral Der (FD)", "Femoral Izq (FI)", "Radial Der (RD)", "Radial Izq (RI)", "M. Sup. Der (MSD)", "M. Sup. Izq (MSI)", "Subclavia Der", "Subclavia Izq"];

        const getAutomaticShift = () => {
            const now = new Date();
            const h = now.getHours();
            if (h >= 6 && h < 13) return "Turno Ma√±ana";
            if (h >= 13 && h < 20) return "Turno Tarde";
            return "Turno Noche";
        };

        const Icon = ({ name, className = "w-5 h-5" }) => {
            const icons = {
                plus: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
                trash: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
                wind: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" /></svg>,
                zap: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>,
                shield: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A3.33 3.33 0 0018.377 2.866L12.04 1l-6.337 1.866a3.33 3.33 0 00-2.28 3.118 11.662 11.662 0 004.398 9.491 2.33 2.33 0 011.04 1.858V21h6.337v-3.667a2.33 2.33 0 011.04-1.858 11.662 11.662 0 004.398-9.491z" /></svg>,
                micro: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" /></svg>,
                drop: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.022.547l-2.387.477a6 6 0 00-3.86-.517" /></svg>,
                x: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
                cloud: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" /></svg>,
                cog: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
                check: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
                info: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
                lock: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>,
                needle: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.022.547l-2.387.477a6 6 0 00-3.86-.517M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
                chart: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>,
                download: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
                home: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>,
                history: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
                calendar: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>,
                back: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
            };
            return <div className={className}>{icons[name]}</div>;
        };

        const Section = ({ title, icon, color, children }) => (
            <div className="bg-white rounded-[2.5rem] border border-iaf-gray shadow-sm overflow-hidden mb-6">
                <div className={`px-6 py-3 border-b border-iaf-gray flex items-center gap-2 ${color} font-black uppercase text-[10px] tracking-widest`}>
                    <Icon name={icon} className="w-4 h-4" /> {title}
                </div>
                <div className="p-6">{children}</div>
            </div>
        );

        const FullShiftReport = ({ patients }) => {
            return (
                <div className="p-8 bg-white text-iaf-dark">
                    <div className="text-center border-b-4 border-iaf-primary pb-4 mb-6 flex justify-between items-end">
                        <div className="text-left">
                            <h1 className="text-3xl font-black text-iaf-primary uppercase tracking-tighter">UTI DIGITAL IAF</h1>
                            <p className="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Instituto Alexander Fleming</p>
                        </div>
                        <div className="text-right">
                            <p className="text-sm font-bold text-gray-800 uppercase">{getAutomaticShift()}</p>
                            <p className="text-xs font-medium text-gray-500">{new Date().toLocaleDateString()}</p>
                        </div>
                    </div>
                    <div className="space-y-4">
                        {patients.map((p, index) => (
                            <div key={p.id} className="break-inside-avoid page-break-after-always border border-gray-200 rounded-2xl overflow-hidden shadow-sm bg-white">
                                <div className="bg-iaf-light px-4 py-2 border-b border-iaf-primary/30 flex justify-between items-center">
                                    <div className="flex items-center gap-3">
                                        <span className="text-lg font-black text-iaf-primary bg-white px-2 rounded border border-iaf-primary">{p.bed}</span>
                                        <span className="text-sm font-bold text-gray-800 uppercase">{p.name || "Paciente Sin Nombre"}</span>
                                        {p.hc && <span className="text-[10px] bg-white px-1.5 py-0.5 rounded border border-gray-300 text-gray-600 font-bold">HC: {p.hc}</span>}
                                    </div>
                                    <div className="flex items-center gap-2">
                                        {p.admissionDate && <span className="text-[9px] font-bold text-iaf-primary">Ing: {p.admissionDate}</span>}
                                        {p.isolation?.type !== 'No' && (
                                            <span className="text-[9px] bg-red-500 text-white px-2 py-0.5 rounded font-black uppercase">
                                                {p.isolation?.type}
                                            </span>
                                        )}
                                    </div>
                                </div>
                                <div className="p-3 grid grid-cols-2 gap-x-4 gap-y-2">
                                    <div className="space-y-2 border-r border-gray-100 pr-2">
                                        <div className="mb-2">
                                            <p className="pdf-section-title">Diagn√≥stico</p>
                                            <div className="mb-1">
                                                <span className="pdf-label">Activo:</span> <span className="pdf-value">{p.diagnosisActive || "-"}</span>
                                            </div>
                                            {p.diagnosisBase && (
                                                <div>
                                                    <span className="pdf-label">Base:</span> <span className="pdf-value text-gray-500">{p.diagnosisBase}</span>
                                                </div>
                                            )}
                                        </div>
                                        <div className="mb-2 bg-cyan-50/50 p-1.5 rounded">
                                            <p className="pdf-section-title !text-cyan-700 !border-cyan-100">Respiratorio</p>
                                            <div className="flex flex-wrap gap-x-3 gap-y-1">
                                                <span><span className="pdf-label">Disp:</span> <span className="pdf-value">{p.respiratory.type}</span></span>
                                                {p.respiratory.type === 'ARM' || p.respiratory.type === 'VNI' ? (
                                                    <>
                                                        <span><span className="pdf-label">Modo:</span> <span className="pdf-value">{p.respiratory.mode}</span></span>
                                                        <span><span className="pdf-label">FiO2:</span> <span className="pdf-value">{p.respiratory.fio2}%</span></span>
                                                        <span><span className="pdf-label">PEEP:</span> <span className="pdf-value">{p.respiratory.peep}</span></span>
                                                        <span><span className="pdf-label">FR:</span> <span className="pdf-value">{p.respiratory.fr}</span></span>
                                                        <span><span className="pdf-label">VT:</span> <span className="pdf-value">{p.respiratory.vt}</span></span>
                                                    </>
                                                ) : (
                                                    <>
                                                        <span><span className="pdf-label">Flujo:</span> <span className="pdf-value">{p.respiratory.liters}</span></span>
                                                        <span><span className="pdf-label">FiO2:</span> <span className="pdf-value">{p.respiratory.fio2}%</span></span>
                                                    </>
                                                )}
                                            </div>
                                        </div>
                                        <div className="mb-2 bg-red-50/50 p-1.5 rounded">
                                            <p className="pdf-section-title !text-red-700 !border-red-100">Hemodinamia</p>
                                            <div className="mb-1">
                                                <span className="pdf-label">PHP:</span> <span className="pdf-value">{p.medication.php}</span>
                                            </div>
                                            <div className="flex flex-wrap gap-1">
                                                {p.medication.infusions.filter(i => i.drug).map((i, k) => (
                                                    <span key={k} className="pdf-tag bg-white border border-red-200 text-red-700">
                                                        {i.drug} {i.rate}ml/h
                                                    </span>
                                                ))}
                                                {p.medication.infusions.filter(i => i.drug).length === 0 && <span className="pdf-label italic font-normal">Sin inotr√≥picos</span>}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="space-y-2">
                                        <div className="mb-2 bg-amber-50/50 p-1.5 rounded">
                                            <p className="pdf-section-title !text-amber-700 !border-amber-100">Infectolog√≠a</p>
                                            <div className="mb-1">
                                                <span className="pdf-label">ATB:</span> 
                                                <span className="pdf-value ml-1">
                                                    {(p.atbs || []).length > 0 ? p.atbs.join(", ") : "Sin ATB"}
                                                </span>
                                            </div>
                                            {p.isolation?.type !== 'No' && (
                                                <div className="mb-1">
                                                    <span className="pdf-label text-red-600">Aislamiento {p.isolation.type}:</span> <span className="pdf-value">{p.isolation.reason}</span>
                                                </div>
                                            )}
                                            {(p.cultures || []).length > 0 && (
                                                <div>
                                                    <span className="pdf-label block mb-0.5">Cultivos:</span>
                                                    {p.cultures.map(c => (
                                                        <div key={c.id} className="text-[8px] leading-tight text-gray-700">
                                                            ‚Ä¢ {c.t} ({c.d}): {c.r}
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                        <div className="mb-2">
                                            <p className="pdf-section-title">Dispositivos</p>
                                            {(p.vascular || []).length > 0 && (
                                                <div className="mb-1">
                                                    <span className="pdf-label">Accesos:</span>
                                                    <div className="flex flex-wrap gap-1">
                                                        {p.vascular.map((v, k) => (
                                                            <span key={k} className="text-[8px] px-1 bg-pink-50 text-pink-700 rounded border border-pink-100">{v.type} ({v.site})</span>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                            {(p.drains || []).length > 0 && (
                                                <div>
                                                    <span className="pdf-label">Drenajes:</span>
                                                    {p.drains.map((d, k) => (
                                                        <div key={k} className="text-[8px] flex justify-between border-b border-gray-50">
                                                            <span>{d.type}: {d.debit} ({d.char})</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                        <div className="mb-2 flex justify-between gap-2">
                                            <div>
                                                <span className="pdf-label">Dieta:</span> <span className="pdf-value">{p.diet}</span>
                                            </div>
                                            <div>
                                                <span className="pdf-label">Diuresis:</span> <span className="pdf-value">{p.elimination.diuresisMethod}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="bg-gray-50 p-2 border-t border-gray-100">
                                    <p className="pdf-label text-gray-400 mb-0.5">Pendientes / Notas:</p>
                                    <p className="text-[9px] text-gray-700 leading-snug whitespace-pre-wrap">{p.notes || "Sin pendientes registrados."}</p>
                                </div>
                            </div>
                        ))}
                    </div>
                    <div className="text-center text-[8px] text-gray-400 mt-6 pt-4 border-t border-gray-100 uppercase tracking-widest">
                        Documento generado el {new Date().toLocaleString()} - Confidencial IAF
                    </div>
                </div>
            );
        };

        const StatsDashboard = ({ patients }) => {
            const stats = useMemo(() => {
                const total = patients.length;
                if (total === 0) return null;

                const armCount = patients.filter(p => p.respiratory.type === 'ARM').length;
                const vniCount = patients.filter(p => p.respiratory.type === 'VNI').length;
                const isolationCount = patients.filter(p => p.isolation.type !== 'No').length;
                const shockCount = patients.filter(p => p.medication.infusions.some(i => ['Noradrenalina', 'Adrenalina', 'Dopamina', 'Vasopresina'].some(d => i.drug && i.drug.includes(d)))).length;
                
                let totalDays = 0;
                let maxDays = 0;
                let maxDaysPatient = "";
                const today = new Date();

                patients.forEach(p => {
                    if (p.admissionDate) {
                        const admission = new Date(p.admissionDate);
                        const diffTime = Math.abs(today - admission);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        totalDays += diffDays;
                        if (diffDays > maxDays) {
                            maxDays = diffDays;
                            maxDaysPatient = p.bed;
                        }
                    }
                });
                const avgDays = totalDays / total;

                return { total, armCount, vniCount, isolationCount, shockCount, avgDays, maxDays, maxDaysPatient };
            }, [patients]);

            const generateSmartReport = () => {
                if (!stats) return "No hay datos suficientes para generar un reporte.";
                
                const reportLines = [];
                const armPercentage = (stats.armCount / stats.total) * 100;
                
                if (armPercentage > 50) {
                    reportLines.push("‚ö†Ô∏è ALERTA: Alta ocupaci√≥n de respiradores (>50%). Se sugiere revisar stock de sedoanalgesia y filtros.");
                } else if (armPercentage > 20) {
                    reportLines.push("‚ÑπÔ∏è Ocupaci√≥n moderada de ARM. Flujo de trabajo estable.");
                } else {
                    reportLines.push("‚úÖ Baja prevalencia de ARM. Disponibilidad de equipos asegurada.");
                }

                if (stats.isolationCount > 2) {
                    reportLines.push("‚ö†Ô∏è ALERTA EPIDEMIOL√ìGICA: M√∫ltiples aislamientos detectados. Reforzar medidas de contacto y lavado de manos.");
                }

                if (stats.avgDays > 10) {
                    reportLines.push("üìâ GIRO DE CAMA LENTO: El promedio de estada supera los 10 d√≠as. Evaluar pases a piso o derivaciones.");
                }

                if (stats.shockCount > stats.total / 3) {
                    reportLines.push("‚ö° ALTA COMPLEJIDAD: M√°s del 30% de los pacientes requieren vasoactivos.");
                }

                return reportLines;
            };

            if (!stats) return <div className="p-10 text-center text-iaf-dark font-bold">Sin datos para analizar.</div>;

            return (
                <div className="p-4 md:p-8 space-y-6 pb-32">
                    <header className="mb-6">
                        <h2 className="text-3xl font-black text-iaf-primary uppercase tracking-tighter">Reporte de Gesti√≥n</h2>
                        <p className="text-sm text-iaf-dark font-medium">An√°lisis semanal autom√°tico basado en datos activos.</p>
                    </header>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="bg-iaf-primary text-white p-5 rounded-3xl shadow-lg">
                            <p className="text-[10px] uppercase font-black tracking-widest opacity-70">Ocupaci√≥n</p>
                            <p className="text-4xl font-black">{stats.total}</p>
                            <p className="text-xs font-bold mt-1">Pacientes Activos</p>
                        </div>
                        <div className="bg-white p-5 rounded-3xl border border-iaf-gray shadow-sm">
                            <p className="text-[10px] uppercase font-black tracking-widest text-gray-400">Invasividad Resp.</p>
                            <p className="text-4xl font-black text-cyan-600">{Math.round((stats.armCount / stats.total) * 100)}%</p>
                            <p className="text-xs font-bold text-gray-500 mt-1">{stats.armCount} en ARM / {stats.vniCount} VNI</p>
                        </div>
                        <div className="bg-white p-5 rounded-3xl border border-iaf-gray shadow-sm">
                            <p className="text-[10px] uppercase font-black tracking-widest text-gray-400">Promedio Estada</p>
                            <p className="text-4xl font-black text-indigo-600">{Math.round(stats.avgDays)}</p>
                            <p className="text-xs font-bold text-gray-500 mt-1">D√≠as por paciente</p>
                        </div>
                        <div className="bg-white p-5 rounded-3xl border border-iaf-gray shadow-sm">
                            <p className="text-[10px] uppercase font-black tracking-widest text-gray-400">Aislamientos</p>
                            <p className="text-4xl font-black text-orange-500">{stats.isolationCount}</p>
                            <p className="text-xs font-bold text-gray-500 mt-1">Pacientes aislados</p>
                        </div>
                    </div>
                    <div className="bg-white border border-iaf-primary p-8 rounded-[2.5rem] shadow-xl relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-64 h-64 bg-iaf-light rounded-full blur-3xl -mr-16 -mt-16 opacity-50"></div>
                        <div className="relative z-10 text-iaf-dark">
                            <h3 className="text-xs font-black uppercase tracking-[0.3em] text-iaf-primary mb-6 flex items-center gap-2">
                                <Icon name="micro" className="w-4 h-4" /> An√°lisis IA de Gesti√≥n
                            </h3>
                            <div className="space-y-4">
                                {generateSmartReport().map((line, i) => (
                                    <p key={i} className="text-sm font-medium border-l-4 border-iaf-primary pl-4 py-1">{line}</p>
                                ))}
                            </div>
                        </div>
                    </div>
                    <div className="bg-iaf-light p-6 rounded-[2rem] border border-iaf-primary">
                        <h3 className="text-xs font-black uppercase text-iaf-primary mb-4 tracking-widest">Paciente con mayor internaci√≥n</h3>
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-2xl font-black text-iaf-dark">{stats.maxDaysPatient}</p>
                                <p className="text-xs font-bold text-gray-500 uppercase">Cama Cr√≠tica</p>
                            </div>
                            <div className="text-right">
                                <p className="text-3xl font-black text-iaf-primary">{stats.maxDays}</p>
                                <p className="text-[10px] font-black text-iaf-primary uppercase">D√≠as Totales</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const HistoryView = ({ fbServices }) => {
            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (fbServices) {
                    const { db, appId, collection, query, orderBy, limit, getDocs } = fbServices;
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'history'), orderBy('date', 'desc'), limit(10));
                    getDocs(q).then(snap => {
                        setHistory(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                        setLoading(false);
                    }).catch(err => {
                        console.error("Error fetching history:", err);
                        setLoading(false);
                    });
                } else {
                    setLoading(false);
                }
            }, [fbServices]);

            if (loading) return <div className="p-10 text-center font-bold text-gray-400">Cargando historial...</div>;
            if (!fbServices) return <div className="p-10 text-center font-bold text-gray-400">Modo Offline: Historial no disponible.</div>;

            return (
                <div className="p-8">
                    <h2 className="text-2xl font-black text-iaf-primary uppercase mb-6 flex items-center gap-2">
                        <Icon name="history" className="w-6 h-6" /> Historial de Guardias
                    </h2>
                    <div className="space-y-3">
                        {history.length === 0 && <p className="text-sm text-gray-500 italic">No hay registros guardados a√∫n.</p>}
                        {history.map(h => (
                            <div key={h.id} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center">
                                <div>
                                    <p className="text-sm font-black text-iaf-dark uppercase">{h.shift} - {new Date(h.date).toLocaleDateString()}</p>
                                    <p className="text-xs text-gray-500">{h.totalPatients} Pacientes activos</p>
                                </div>
                                <span className="text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded font-bold uppercase">Guardado</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const BedGrid = ({ patients, onSelectBed, onCreateBed }) => {
            return (
                <div className="p-8 pb-32">
                     <h2 className="text-2xl font-black text-iaf-primary uppercase mb-6 flex items-center gap-2">
                        <Icon name="home" className="w-6 h-6" /> Panel de Camas
                    </h2>
                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        {BED_OPTIONS.map(bed => {
                            const patient = patients.find(p => p.bed === bed);
                            return (
                                <button 
                                    key={bed}
                                    onClick={() => patient ? onSelectBed(patient.id) : onCreateBed(bed)}
                                    className={`relative p-4 rounded-[1.5rem] border-2 flex flex-col items-start justify-between h-40 transition-all active:scale-95 shadow-sm text-left ${patient ? 'bg-iaf-primary border-iaf-primary text-white shadow-lg' : 'bg-white border-gray-200 text-gray-400 hover:border-iaf-primary hover:text-iaf-primary'}`}
                                >
                                    <div className="w-full flex justify-between items-start">
                                        <span className={`text-xs font-black uppercase tracking-widest ${patient ? 'text-iaf-light' : 'text-gray-300'}`}>{bed}</span>
                                        {patient?.isolation?.type !== 'No' && (
                                            <Icon name="shield" className="w-4 h-4 text-red-300" />
                                        )}
                                    </div>
                                    
                                    {patient ? (
                                        <div className="w-full">
                                            <p className="text-lg font-black leading-tight uppercase line-clamp-2">{patient.name || "Sin Nombre"}</p>
                                            <div className="mt-2 flex gap-1 flex-wrap">
                                                 {patient.respiratory.type === 'ARM' && <span className="text-[9px] bg-white/20 px-1.5 py-0.5 rounded font-bold uppercase">ARM</span>}
                                                 {patient.isolation.type !== 'No' && <span className="text-[9px] bg-red-500 px-1.5 py-0.5 rounded font-bold uppercase">AIS</span>}
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="w-full flex flex-col items-center justify-center opacity-50">
                                            <Icon name="plus" className="w-8 h-8 mb-1" />
                                            <span className="text-[10px] font-bold uppercase">Ingresar</span>
                                        </div>
                                    )}
                                </button>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [patients, setPatients] = useState([]);
            const [selectedId, setSelectedId] = useState(null);
            const [isEditing, setIsEditing] = useState(false);
            const [currentView, setCurrentView] = useState('home'); 
            const [formState, setFormState] = useState(null);
            const [tempCulture, setTempCulture] = useState({ t: 'HMC x 2', d: new Date().toISOString().split('T')[0], r: '' });
            const [tempVascular, setTempVascular] = useState({ type: 'AVC (Venoso Central)', site: 'Yugular Der (YD)' });
            const [appMode, setAppMode] = useState('loading');
            const [fbServices, setFbServices] = useState(null);
            const [isExporting, setIsExporting] = useState(false);
            
            const [showConfig, setShowConfig] = useState(false);
            const [manualConfig, setManualConfig] = useState('');
            
            useEffect(() => {
                const savedConfig = localStorage.getItem('uti_firebase_config_manual');
                if (savedConfig) setManualConfig(savedConfig);

                const initSystem = async () => {
                    if (window.fb) {
                        try {
                            const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, orderBy, limit, getDocs } = window.fb;
                            
                            let firebaseConfig = null;
                            let isManual = false;

                            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                                firebaseConfig = JSON.parse(__firebase_config);
                            } else if (savedConfig) {
                                try {
                                    firebaseConfig = JSON.parse(savedConfig);
                                    isManual = true;
                                } catch (e) { console.error("Config manual inv√°lida"); }
                            }

                            if (firebaseConfig) {
                                const app = initializeApp(firebaseConfig, isManual ? "manualApp" : undefined);
                                const auth = getAuth(app);
                                const db = getFirestore(app);
                                const appId = typeof __app_id !== 'undefined' ? __app_id : 'uti-handover-v28-commercial';

                                if (!isManual && typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                    await signInWithCustomToken(auth, __initial_auth_token);
                                } else {
                                    await signInAnonymously(auth);
                                }
                                
                                setFbServices({ db, appId, collection, onSnapshot, doc, setDoc, deleteDoc, query, orderBy, limit, getDocs });
                                setAppMode('firebase');
                                
                                onAuthStateChanged(auth, (u) => {
                                    if (u) {
                                        const q = collection(db, 'artifacts', appId, 'public', 'data', 'patients');
                                        onSnapshot(q, (snap) => {
                                            const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                                            setPatients(data.sort((a, b) => a.bed.localeCompare(b.bed, undefined, { numeric: true, sensitivity: 'base' })));
                                        });
                                    }
                                });
                            } else {
                                throw new Error("No firebase config");
                            }

                        } catch (e) {
                            console.warn("Modo offline activado:", e);
                            setAppMode('offline');
                        }
                    } else {
                        setAppMode('offline');
                    }
                };
                initSystem();
            }, []);

            const saveManualConfig = () => {
                localStorage.setItem('uti_firebase_config_manual', manualConfig);
                window.location.reload();
            };

            const clearManualConfig = () => {
                localStorage.removeItem('uti_firebase_config_manual');
                window.location.reload();
            };

            useEffect(() => {
                if (appMode === 'offline') {
                    const unsubscribe = MockDB.subscribe((data) => {
                        setPatients(data.sort((a, b) => a.bed.localeCompare(b.bed, undefined, { numeric: true, sensitivity: 'base' })));
                    });
                    return unsubscribe;
                }
            }, [appMode]);

            useEffect(() => {
                if (selectedId && patients.length > 0) {
                    const p = patients.find(p => p.id === selectedId);
                    setFormState(prev => {
                         if (!prev || prev.id !== selectedId) return p;
                         return prev;
                    });
                }
            }, [selectedId, patients]);

            const handleCloseShift = async () => {
                setIsExporting(true);
                const element = document.getElementById('printable-content');
                element.style.display = 'block';
                
                const opt = {
                    margin:       10,
                    filename:     `Guardia_IAF_${new Date().toISOString().split('T')[0]}_${getAutomaticShift().replace(/\s/g,'')}.pdf`,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2 },
                    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                try {
                    await html2pdf().set(opt).from(element).save();
                    if (appMode === 'firebase' && fbServices) {
                        const { db, appId, setDoc, doc } = fbServices;
                        const shiftId = `${new Date().toISOString().split('T')[0]}_${getAutomaticShift().replace(/\s/g,'')}`;
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'history', shiftId), {
                            date: new Date().toISOString(),
                            shift: getAutomaticShift(),
                            totalPatients: patients.length,
                            patientsSnapshot: patients
                        });
                        alert("‚úÖ Turno cerrado con √©xito.");
                    } else {
                        alert("üìÑ PDF Generado.");
                    }
                } catch (e) {
                    console.error("Error cerrando turno:", e);
                    alert("Hubo un error al generar el reporte.");
                } finally {
                    element.style.display = 'none';
                    setIsExporting(false);
                }
            };

            const saveData = async (id, data) => {
                if (appMode === 'firebase' && fbServices) {
                    const { db, appId, doc, setDoc } = fbServices;
                    try {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'patients', id), data, { merge: true });
                    } catch (e) { console.error(e); }
                } else {
                    MockDB.update(id, data);
                }
            };
            
            const handleDelete = async (id) => {
                if (window.confirm("¬øConfirmar ALTA / BAJA? Esta acci√≥n no se puede deshacer.")) {
                    if (appMode === 'firebase' && fbServices) {
                        const { db, appId, doc, deleteDoc } = fbServices;
                        try {
                            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'patients', id));
                        } catch (e) { console.error(e); }
                    } else {
                        MockDB.delete(id);
                    }
                    if (selectedId === id) {
                        setSelectedId(null);
                        setCurrentView('home');
                    }
                }
            };

            const saveRef = useRef();
            saveRef.current = saveData;

            const debouncedSave = useCallback((id, data) => {
                if (appMode === 'offline') {
                    saveRef.current(id, data);
                } else {
                    setTimeout(() => saveRef.current(id, data), 1000);
                }
            }, [appMode]);

            const updateForm = (updates) => {
                if (!formState) return;
                const newState = { ...formState, ...updates };
                setFormState(newState);
                debouncedSave(selectedId, updates);
            };

            const handleCreate = async (preSelectedBed = "Cama 1") => {
                const id = Date.now().toString();
                const newP = {
                    bed: preSelectedBed, name: "", hc: "", diagnosisBase: "", diagnosisActive: "",
                    admissionDate: new Date().toISOString().split('T')[0],
                    respiratory: { type: "AA", fio2: "21", liters: "0", mode: "VC", vt: "", peep: "", fr: "" },
                    medication: { php: "21ml/h", infusions: Array(10).fill({ drug: "", rate: "" }) },
                    atbs: [], cultures: [], drains: [], 
                    vascular: [],
                    isolation: { type: "No", reason: "" },
                    diet: "VO", dietTolerance: "Buena tolerancia", dietFlow: "",
                    elimination: { diuresisMethod: "Sonda Vesical", diuresisChar: "Normal", catarsisStatus: "Positiva", catarsisChar: "Normal" },
                    notes: ""
                };
                
                await saveData(id, newP);
                setSelectedId(id);
                setFormState({ id, ...newP });
                setIsEditing(true);
                setCurrentView('detail');
            };

            const toggleAtb = (atb) => {
                if (!formState) return;
                const current = formState.atbs || [];
                if (!current.includes(atb)) {
                    updateForm({ atbs: [...current, atb] });
                }
            };

            const removeAtb = (atb) => {
                if (!formState) return;
                const current = formState.atbs || [];
                updateForm({ atbs: current.filter(x => x !== atb) });
            }

            const addCulture = () => {
                if (!formState) return;
                const next = [...(formState.cultures || []), { ...tempCulture, id: Date.now() }];
                updateForm({ cultures: next });
                setTempCulture(prev => ({ ...prev, r: '' }));
            };

            const removeCulture = (cid) => {
                if (!formState) return;
                const next = (formState.cultures || []).filter(c => c.id !== cid);
                updateForm({ cultures: next });
            };

            const addVascular = () => {
                if (!formState) return;
                const next = [...(formState.vascular || []), { ...tempVascular, id: Date.now() }];
                updateForm({ vascular: next });
            };

            const removeVascular = (vid) => {
                if (!formState) return;
                const next = (formState.vascular || []).filter(v => v.id !== vid);
                updateForm({ vascular: next });
            };

            const editorData = formState || {};
            const reportData = isEditing ? editorData : (patients.find(p => p.id === selectedId) || {});

            if (appMode === 'loading') return <div className="h-screen flex items-center justify-center text-gray-400 font-bold">Cargando Sistema...</div>;

            return (
                <div className="flex flex-col md:flex-row h-screen overflow-hidden bg-[#f8fafc]">
                    {/* Lateral */}
                    <aside className="w-full md:w-20 lg:w-24 bg-iaf-primary text-white flex flex-col items-center py-6 shadow-2xl z-10 relative">
                         <div className="mb-8 text-center">
                             <div className="w-10 h-10 bg-white rounded-full flex items-center justify-center text-iaf-primary font-black text-xl mb-2 mx-auto">UTI</div>
                         </div>
                         
                         <div className="flex-1 flex flex-col gap-4 w-full px-2">
                             <button onClick={() => { setSelectedId(null); setCurrentView('home'); }} className={`p-3 rounded-2xl transition-all flex flex-col items-center justify-center gap-1 ${currentView === 'home' ? 'bg-white text-iaf-primary shadow-lg' : 'text-white/70 hover:bg-white/10 hover:text-white'}`} title="Panel de Camas">
                                <Icon name="home" className="w-6 h-6" />
                                <span className="text-[9px] font-bold uppercase">Panel</span>
                            </button>
                            
                            <button onClick={() => setCurrentView('stats')} className={`p-3 rounded-2xl transition-all flex flex-col items-center justify-center gap-1 ${currentView === 'stats' ? 'bg-white text-iaf-primary shadow-lg' : 'text-white/70 hover:bg-white/10 hover:text-white'}`} title="Estad√≠sticas">
                                <Icon name="chart" className="w-6 h-6" />
                                <span className="text-[9px] font-bold uppercase">Datos</span>
                            </button>

                            <button onClick={() => setCurrentView('history')} className={`p-3 rounded-2xl transition-all flex flex-col items-center justify-center gap-1 ${currentView === 'history' ? 'bg-white text-iaf-primary shadow-lg' : 'text-white/70 hover:bg-white/10 hover:text-white'}`} title="Historial">
                                <Icon name="history" className="w-6 h-6" />
                                <span className="text-[9px] font-bold uppercase">Hist.</span>
                            </button>
                         </div>
                         
                         <div className="w-full px-2 space-y-4">
                            <button onClick={() => setShowConfig(true)} className={`w-full p-3 rounded-2xl transition-all flex flex-col items-center justify-center gap-1 ${appMode === 'firebase' ? 'text-green-300 bg-green-900/20' : 'text-white/50 hover:bg-white/10'}`} title="Configuraci√≥n">
                                <Icon name={appMode === 'firebase' ? 'cloud' : 'cog'} className="w-6 h-6" />
                            </button>
                            
                            <button onClick={handleCloseShift} disabled={isExporting} className="w-full p-3 bg-white/10 rounded-2xl hover:bg-white/20 transition-all flex flex-col items-center justify-center gap-1 text-white border border-white/20" title="Cerrar Turno">
                                {isExporting ? <span className="text-[8px] animate-pulse">...</span> : <Icon name="download" className="w-6 h-6" />}
                            </button>
                         </div>
                    </aside>

                    {/* Principal */}
                    <main className="flex-1 overflow-y-auto custom-scrollbar relative">
                        {currentView === 'home' && (
                            <BedGrid 
                                patients={patients} 
                                onSelectBed={(id) => { setSelectedId(id); setCurrentView('detail'); setIsEditing(false); }}
                                onCreateBed={(bed) => handleCreate(bed)}
                            />
                        )}
                        
                        {currentView === 'stats' && <StatsDashboard patients={patients} />}
                        
                        {currentView === 'history' && <HistoryView fbServices={fbServices} />}
                        
                        {(currentView === 'detail' && selectedId) && (
                            <div className="max-w-4xl mx-auto p-4 md:p-8">
                                <header className="bg-white px-6 py-4 rounded-[1.5rem] shadow-sm border border-iaf-gray mb-8 flex flex-col md:flex-row justify-between items-center sticky top-0 z-20 backdrop-blur-md bg-white/95">
                                    <div className="flex items-center gap-4">
                                        <button onClick={() => setCurrentView('home')} className="bg-gray-100 text-gray-500 hover:bg-gray-200 hover:text-gray-700 p-2 rounded-xl transition-colors flex items-center gap-2 pr-4">
                                            <Icon name="back" className="w-5 h-5" />
                                            <span className="text-[10px] font-black uppercase">Volver</span>
                                        </button>
                                        <div className="h-8 w-px bg-gray-200"></div>
                                        <div>
                                             <h2 className="text-2xl font-black text-iaf-primary leading-none uppercase tracking-tighter">{reportData.bed}</h2>
                                             <h3 className="text-sm font-bold text-iaf-dark uppercase tracking-tight">{reportData.name || "---"}</h3>
                                        </div>
                                    </div>
                                    
                                    <div className="flex gap-2 mt-4 md:mt-0">
                                        <button type="button" onClick={() => handleDelete(selectedId)} className="bg-red-50 text-red-500 px-4 py-2.5 rounded-xl font-black text-[10px] uppercase hover:bg-red-100 border border-red-100">DAR DE ALTA</button>
                                        <button type="button" onClick={() => setIsEditing(!isEditing)} className="bg-iaf-primary text-white px-6 py-2.5 rounded-xl font-black text-[10px] uppercase tracking-widest active:scale-95 shadow-lg whitespace-nowrap hover:bg-[#961166] transition-colors">
                                            {isEditing ? "VER REPORTE" : "EDITAR PASE"}
                                        </button>
                                    </div>
                                </header>

                                {isEditing ? (
                                    <div className="space-y-6 pb-40">
                                        <div className="bg-iaf-light rounded-[2.5rem] border border-iaf-primary shadow-sm overflow-hidden mb-6">
                                            <div className="px-6 py-3 border-b border-white/50 flex items-center gap-2 bg-iaf-primary text-white font-black uppercase text-[10px] tracking-widest">
                                                <Icon name="shield" className="w-4 h-4" /> Identificaci√≥n
                                            </div>
                                            <div className="p-6">
                                                <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                                                    <div><label className="text-[9px] font-black uppercase text-iaf-primary ml-2">Cama</label>
                                                        <select className="w-full bg-white p-3 font-bold border-2 border-white/50" value={editorData.bed || ''} onChange={e => updateForm({ bed: e.target.value })}>{BED_OPTIONS.map(o => <option key={o} value={o}>{o}</option>)}</select>
                                                    </div>
                                                    <div className="md:col-span-2"><label className="text-[9px] font-black uppercase text-iaf-primary ml-2">Nombre Completo</label>
                                                        <input className="w-full bg-white p-3 font-bold border-2 border-white/50" value={editorData.name || ''} onChange={e => updateForm({ name: e.target.value })} />
                                                    </div>
                                                    <div><label className="text-[9px] font-black uppercase text-iaf-primary ml-2">HC / ID</label>
                                                        <input className="w-full bg-white p-3 font-bold border-2 border-white/50" placeholder="N¬∞ HC" value={editorData.hc || ''} onChange={e => updateForm({ hc: e.target.value })} />
                                                    </div>
                                                    <div><label className="text-[9px] font-black uppercase text-iaf-primary ml-2">Fecha Ingreso</label>
                                                        <input type="date" className="w-full bg-white p-3 font-bold border-2 border-white/50" value={editorData.admissionDate || ''} onChange={e => updateForm({ admissionDate: e.target.value })} />
                                                    </div>
                                                </div>
                                                
                                                <div className="bg-white p-4 rounded-3xl border border-white/50 mb-4 flex flex-col md:flex-row items-start md:items-center gap-4">
                                                    <div className="w-full md:w-1/3">
                                                        <label className="text-[9px] font-black uppercase text-orange-600 ml-2">Aislamiento</label>
                                                        <select className="w-full bg-white p-2 font-bold border rounded-xl" value={editorData.isolation?.type || 'No'} onChange={e => updateForm({ isolation: { ...editorData.isolation, type: e.target.value } })}>
                                                            {ISOLATION_TYPES.map(t => <option key={t} value={t}>{t}</option>)}
                                                        </select>
                                                    </div>
                                                    {editorData.isolation?.type !== 'No' && (
                                                        <div className="w-full md:flex-1 animate-in fade-in slide-in-from-left-2">
                                                            <label className="text-[9px] font-black uppercase text-orange-600 ml-2">Germen / Motivo</label>
                                                            <input className="w-full bg-white p-2 font-bold border rounded-xl" placeholder="Ej: KPC, SAMR, COVID..." value={editorData.isolation?.reason || ''} onChange={e => updateForm({ isolation: { ...editorData.isolation, reason: e.target.value } })} />
                                                        </div>
                                                    )}
                                                </div>

                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                     <div className="bg-white p-4 rounded-3xl border border-white/50">
                                                        <label className="text-[9px] font-black uppercase text-gray-400">Antecedentes</label>
                                                        <textarea className="w-full bg-transparent font-semibold mt-1 text-iaf-dark border-none resize-none h-20" value={editorData.diagnosisBase || ''} onChange={e => updateForm({ diagnosisBase: e.target.value })} />
                                                    </div>
                                                    <div className="bg-white p-4 rounded-3xl border border-white/50">
                                                        <label className="text-[9px] font-black uppercase text-iaf-primary">Motivo de Ingreso (Actual)</label>
                                                        <textarea className="w-full bg-transparent font-bold mt-1 text-iaf-dark border-none resize-none h-20" value={editorData.diagnosisActive || ''} onChange={e => updateForm({ diagnosisActive: e.target.value })} />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <Section title="Respiratorio" icon="wind" color="text-cyan-600 bg-cyan-50">
                                            <div className="mb-4">
                                                <label className="text-[9px] font-black uppercase text-cyan-600 ml-2">Dispositivo</label>
                                                <select className="w-full bg-white p-3 font-bold border-2 border-gray-100" value={editorData.respiratory?.type || ''} onChange={e => updateForm({ respiratory: { ...editorData.respiratory, type: e.target.value } })}>{RESP_DEVICES.map(o => <option key={o} value={o}>{o}</option>)}</select>
                                            </div>
                                            
                                            { (editorData.respiratory?.type === "C√°nula Nasal" || editorData.respiratory?.type === "M√°scara Reservorio" || editorData.respiratory?.type === "M√°scara Simple") ? (
                                                <div className="bg-cyan-50/50 p-4 rounded-3xl border border-cyan-100">
                                                    <label className="text-[9px] font-bold text-cyan-600 uppercase ml-1">Litros (L/min)</label>
                                                    <input type="number" className="w-full p-3 font-bold bg-white border-2 border-cyan-100" value={editorData.respiratory?.liters || ''} onChange={e => updateForm({ respiratory: { ...editorData.respiratory, liters: e.target.value } })} />
                                                </div>
                                            ) : (editorData.respiratory?.type === "ARM" || editorData.respiratory?.type === "VNI") ? (
                                                <div className="grid grid-cols-2 md:grid-cols-5 gap-3 bg-cyan-50/50 p-4 rounded-3xl border border-cyan-100">
                                                    <div><label className="text-[9px] font-bold text-cyan-600 uppercase">Modalidad</label>
                                                        <select className="w-full p-2 text-xs font-bold" value={editorData.respiratory?.mode || ''} onChange={e => updateForm({ respiratory: { ...editorData.respiratory, mode: e.target.value } })}>{ARM_MODES.map(o => <option key={o} value={o}>{o}</option>)}</select>
                                                    </div>
                                                    <div><label className="text-[9px] font-bold text-cyan-600 uppercase">FiO2 %</label><input type="number" className="w-full p-2 text-xs font-bold" value={editorData.respiratory?.fio2 || ''} onChange={e => updateForm({ respiratory: { ...editorData.respiratory, fio2: e.target.value } })} /></div>
                                                    <div><label className="text-[9px] font-bold text-cyan-600 uppercase">VT (ml)</label><input type="number" className="w-full p-2 text-xs font-bold" value={editorData.respiratory?.vt || ''} onChange={e => updateForm({ respiratory: { ...editorData.respiratory, vt: e.target.value } })} /></div>
                                                    <div><label className="text-[9px] font-bold text-cyan-600 uppercase">FR</label><input type="number" className="w-full p-2 text-xs font-bold" value={editorData.respiratory?.fr || ''} onChange={e => updateForm({ respiratory: { ...editorData.respiratory, fr: e.target.value } })} /></div>
                                                    <div><label className="text-[9px] font-bold text-cyan-600 uppercase">PEEP</label><input type="number" className="w-full p-2 text-xs font-bold" value={editorData.respiratory?.peep || ''} onChange={e => updateForm({ respiratory: { ...editorData.respiratory, peep: e.target.value } })} /></div>
                                                </div>
                                            ) : (
                                                <div className="grid grid-cols-2 gap-3 bg-cyan-50/50 p-4 rounded-3xl border border-cyan-100">
                                                    <div><label className="text-[9px] font-bold text-cyan-600 uppercase">FiO2 %</label><input type="number" className="w-full p-3 text-xs font-bold" value={editorData.respiratory?.fio2 || ''} onChange={e => updateForm({ respiratory: { ...editorData.respiratory, fio2: e.target.value } })} /></div>
                                                    <div><label className="text-[9px] font-bold text-cyan-600 uppercase">Litros / Flujo</label><input className="w-full p-3 text-xs font-bold" value={editorData.respiratory?.liters || ''} onChange={e => updateForm({ respiratory: { ...editorData.respiratory, liters: e.target.value } })} /></div>
                                                </div>
                                            )}
                                        </Section>

                                        <Section title="Esquema Antibi√≥tico" icon="micro" color="text-amber-600 bg-amber-50">
                                            <div className="mb-4">
                                                <label className="text-[9px] font-black uppercase text-amber-600 ml-1">Agregar Antibi√≥tico</label>
                                                <select className="w-full bg-white p-3 font-bold border-2 border-amber-100 rounded-xl mt-1" value="" onChange={(e) => { if (e.target.value) toggleAtb(e.target.value); }}>
                                                    <option value="">Seleccionar de la lista...</option>
                                                    {ATB_LIST.sort().map(a => (<option key={a} value={a} disabled={editorData.atbs?.includes(a)}>{a}</option>))}
                                                </select>
                                            </div>
                                            <div className="p-4 bg-amber-50 rounded-2xl border-2 border-dashed border-amber-200 min-h-[60px]">
                                                <p className="text-[9px] font-black uppercase text-amber-500 mb-2">Antibi√≥ticos Activos:</p>
                                                <div className="flex flex-wrap gap-2">
                                                    {(editorData.atbs || []).map(a => (
                                                        <span key={a} className="bg-amber-600 text-white px-3 py-1.5 rounded-xl text-[10px] font-black flex items-center gap-2 shadow-sm uppercase">
                                                            {a} <button type="button" onClick={() => removeAtb(a)} className="hover:text-red-200"><Icon name="x" className="w-3 h-3" /></button>
                                                        </span>
                                                    ))}
                                                    {(editorData.atbs || []).length === 0 && <p className="text-[10px] italic text-amber-300">Ninguno seleccionado</p>}
                                                </div>
                                            </div>
                                        </Section>

                                        <Section title="Medicaci√≥n y Paralelos" icon="zap" color="text-red-600 bg-red-50">
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                                <div className="bg-red-50 p-3 rounded-2xl border border-red-100">
                                                    <label className="text-[9px] font-black uppercase text-red-400 ml-1">PHP</label>
                                                    <select className="w-full bg-white p-2 font-bold mt-1" value={editorData.medication?.php || ''} onChange={e => updateForm({ medication: { ...editorData.medication, php: e.target.value } })}>{PHP_OPTIONS.map(o => <option key={o} value={o}>{o}</option>)}</select>
                                                </div>
                                                <div className="bg-indigo-50 p-3 rounded-2xl border border-indigo-100">
                                                    <label className="text-[9px] font-black uppercase text-indigo-400 ml-1">Alimentaci√≥n</label>
                                                    <select className="w-full bg-white p-2 font-bold mt-1" value={editorData.diet || ''} onChange={e => updateForm({ diet: e.target.value })}>{DIET.map(o => <option key={o} value={o}>{o}</option>)}</select>
                                                    {["K108", "Gastrostom√≠a", "Yeyunostom√≠a"].includes(editorData.diet) && 
                                                        <select className="w-full bg-white p-2 font-bold mt-2 border-2 border-indigo-200" value={editorData.dietFlow || ''} onChange={e => updateForm({ dietFlow: e.target.value })}><option value="">Flujo ml/h...</option>{ENTERAL_FLOW.map(o => <option key={o} value={o}>{o}</option>)}</select>
                                                    }
                                                </div>
                                            </div>
                                            <div className="space-y-2">
                                                <p className="text-[9px] font-black text-gray-400 uppercase ml-2">Paralelos / BIC (10 slots)</p>
                                                {(editorData.medication?.infusions || Array(10).fill({ drug: "", rate: "" })).map((inf, i) => (
                                                    <div key={i} className="grid grid-cols-12 gap-2">
                                                        <select className="col-span-8 bg-white p-2 text-xs font-bold border-2 border-gray-100" value={inf.drug || ''} onChange={e => { const n = [...(editorData.medication?.infusions || [])]; n[i] = { ...n[i], drug: e.target.value }; updateForm({ medication: { ...editorData.medication, infusions: n } }); }}>
                                                            <option value="">Cerrado</option>
                                                            {INFUSION_DRUGS.map(g => <optgroup key={g.group} label={g.group}>{g.items.map(it => <option key={it} value={it}>{it}</option>)}</optgroup>)}
                                                        </select>
                                                        <input type="number" className="col-span-4 bg-white p-2 text-xs font-bold border-2 border-gray-100 text-red-600" value={inf.rate || ''} placeholder="ml/h" onChange={e => { const n = [...(editorData.medication?.infusions || [])]; n[i] = { ...n[i], rate: e.target.value }; updateForm({ medication: { ...editorData.medication, infusions: n } }); }} />
                                                    </div>
                                                ))}
                                            </div>
                                        </Section>

                                        <Section title="Accesos Vasculares" icon="needle" color="text-pink-600 bg-pink-50">
                                            <div className="bg-white p-4 rounded-3xl border border-pink-100 mb-4">
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                                    <div>
                                                        <label className="text-[9px] font-bold text-gray-400 ml-1">Dispositivo</label>
                                                        <select className="w-full text-[11px] p-2 bg-white border rounded-xl font-bold" value={tempVascular.type} onChange={e => setTempVascular({...tempVascular, type: e.target.value})}>
                                                            {VASCULAR_TYPES.map(o => <option key={o} value={o}>{o}</option>)}
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="text-[9px] font-bold text-gray-400 ml-1">Ubicaci√≥n</label>
                                                        <select className="w-full text-[11px] p-2 bg-white border rounded-xl font-bold" value={tempVascular.site} onChange={e => setTempVascular({...tempVascular, site: e.target.value})}>
                                                            {VASCULAR_SITES.map(o => <option key={o} value={o}>{o}</option>)}
                                                        </select>
                                                    </div>
                                                </div>
                                                <button type="button" onClick={addVascular} className="w-full py-2 bg-pink-600 text-white rounded-xl font-black text-[10px] uppercase shadow-md active:scale-95 transition-transform flex justify-center items-center gap-2 hover:bg-pink-700">
                                                    <Icon name="plus" className="w-3 h-3" /> Agregar Acceso
                                                </button>
                                            </div>
                                            
                                            <div className="flex flex-col gap-2">
                                                {(editorData.vascular || []).length === 0 && <p className="text-[10px] italic text-pink-300 text-center">Sin accesos registrados</p>}
                                                {(editorData.vascular || []).map(v => (
                                                    <div key={v.id} className="flex justify-between items-center bg-pink-50 border border-pink-200 p-3 rounded-2xl">
                                                        <div className="flex flex-col">
                                                            <span className="text-[11px] font-black text-pink-700 uppercase">{v.type}</span>
                                                            <span className="text-[10px] font-bold text-gray-500 uppercase">{v.site}</span>
                                                        </div>
                                                        <button type="button" onClick={() => removeVascular(v.id)} className="text-pink-400 hover:text-red-500 bg-white p-1 rounded-full shadow-sm">
                                                            <Icon name="trash" className="w-4 h-4" />
                                                        </button>
                                                    </div>
                                                ))}
                                            </div>
                                        </Section>

                                        <Section title="Eliminaci√≥n y Cultivos" icon="drop" color="text-emerald-600 bg-emerald-50">
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                <div className="space-y-4">
                                                    <div className="bg-emerald-50 p-4 rounded-3xl border border-emerald-100">
                                                        <label className="text-[9px] font-black uppercase text-emerald-600 ml-1">Diuresis</label>
                                                        <select className="w-full p-2 text-xs font-bold bg-white mt-1 border" value={editorData.elimination?.diuresisMethod || ''} onChange={e => updateForm({ elimination: { ...editorData.elimination, diuresisMethod: e.target.value } })}>{DIURESIS_METHODS.map(o => <option key={o} value={o}>{o}</option>)}</select>
                                                        <select className="w-full p-2 text-xs font-bold bg-white mt-2 border" value={editorData.elimination?.diuresisChar || ''} onChange={e => updateForm({ elimination: { ...editorData.elimination, diuresisChar: e.target.value } })}>{DIURESIS_CHARS.map(o => <option key={o} value={o}>{o}</option>)}</select>
                                                    </div>
                                                    <div className="bg-emerald-50 p-4 rounded-3xl border border-emerald-100">
                                                        <label className="text-[9px] font-black uppercase text-emerald-600 ml-1">Catarsis</label>
                                                        <div className="grid grid-cols-2 gap-2">
                                                            <select className="w-full p-2 text-xs font-bold bg-white mt-1 border" value={editorData.elimination?.catarsisStatus || ''} onChange={e => updateForm({ elimination: { ...editorData.elimination, catarsisStatus: e.target.value } })}>{CATARSIS_STATUS.map(o => <option key={o} value={o}>{o}</option>)}</select>
                                                            <select className="w-full p-2 text-xs font-bold bg-white mt-1 border" value={editorData.elimination?.catarsisChar || ''} onChange={e => updateForm({ elimination: { ...editorData.elimination, catarsisChar: e.target.value } })}>{CATARSIS_CHARS.map(o => <option key={o} value={o}>{o}</option>)}</select>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="bg-white p-4 rounded-3xl border border-gray-100">
                                                    <h3 className="text-[10px] font-black uppercase text-indigo-600 mb-2 ml-1">Cultivos</h3>
                                                    <div className="flex flex-col gap-2 mb-4">
                                                        <div className="flex gap-2">
                                                            <div className="flex-1">
                                                                <label className="text-[9px] font-bold text-gray-400 ml-1">Tipo</label>
                                                                <select className="w-full text-[10px] p-2 bg-white border rounded-xl" value={tempCulture.t} onChange={e => setTempCulture({...tempCulture, t: e.target.value})}>{CULTURE_TYPES.map(o => <option key={o} value={o}>{o}</option>)}</select>
                                                            </div>
                                                            <div className="w-24">
                                                                <label className="text-[9px] font-bold text-gray-400 ml-1">Fecha</label>
                                                                <input type="date" className="w-full text-[10px] p-2 bg-white border rounded-xl" value={tempCulture.d} onChange={e => setTempCulture({...tempCulture, d: e.target.value})} />
                                                            </div>
                                                        </div>
                                                        <div className="flex gap-2 items-end">
                                                             <div className="flex-1">
                                                                <label className="text-[9px] font-bold text-gray-400 ml-1">Resultado (Germen)</label>
                                                                <input type="text" placeholder="Ej: Negativo, KPC..." className="w-full text-[10px] p-2 bg-white border rounded-xl" value={tempCulture.r} onChange={e => setTempCulture({...tempCulture, r: e.target.value})} />
                                                            </div>
                                                            <button type="button" onClick={addCulture} className="bg-indigo-600 text-white p-2 rounded-xl shadow-md h-[34px] w-[34px] flex items-center justify-center hover:bg-indigo-700 transition-colors"><Icon name="plus" className="w-4 h-4" /></button>
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="flex flex-wrap gap-2 min-h-[40px] p-2 bg-indigo-50 rounded-2xl border border-indigo-100">
                                                        {(editorData.cultures || []).length === 0 && <span className="text-[9px] text-indigo-300 italic p-1">Sin cultivos agregados</span>}
                                                        {(editorData.cultures || []).map(c => (
                                                            <span key={c.id} className="bg-indigo-600 text-white px-3 py-1.5 rounded-xl text-[10px] font-black flex items-center gap-2 shadow-sm uppercase animate-in fade-in zoom-in duration-200">
                                                                <span className="flex flex-col leading-none">
                                                                    <span>{c.t} <span className="font-normal opacity-75">| {c.d}</span></span>
                                                                    {c.r && <span className="text-[8px] text-indigo-100 mt-0.5">{c.r}</span>}
                                                                </span>
                                                                <button type="button" onClick={() => removeCulture(c.id)} className="hover:text-red-200"><Icon name="x" className="w-3 h-3" /></button>
                                                            </span>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        </Section>

                                        <Section title="Drenajes Numerados" icon="drop" color="text-orange-600 bg-orange-50">
                                            <div className="flex justify-between items-center mb-4">
                                                <p className="text-[9px] font-black text-gray-400 uppercase">Gesti√≥n de dispositivos</p>
                                                <button type="button" onClick={() => updateForm({ drains: [...(editorData.drains || []), { id: Date.now(), type: 'Drenaje 1', debit: '+', char: 'Seroso' }] })} className="bg-orange-600 text-white px-4 py-2 rounded-xl text-[10px] font-black shadow-md uppercase hover:bg-orange-700">Nuevo Drenaje</button>
                                            </div>
                                            <div className="space-y-4">
                                                {(editorData.drains || []).map((d, i) => (
                                                    <div key={d.id} className="p-4 bg-orange-50/50 rounded-3xl grid grid-cols-1 md:grid-cols-3 gap-3 relative border border-orange-100">
                                                        <button type="button" onClick={() => updateForm({ drains: editorData.drains.filter(dr => dr.id !== d.id) })} className="absolute -top-2 -right-2 bg-white text-red-500 rounded-full p-1 border shadow-sm font-black hover:bg-red-50"><Icon name="x" className="w-4 h-4" /></button>
                                                        <div><label className="text-[9px] font-bold text-orange-400 ml-1 uppercase">Drenaje {i+1}</label>
                                                            <select className="w-full text-[11px] font-bold p-2 bg-white mt-1 border" value={d.type} onChange={e => { const nd = [...editorData.drains]; nd[i] = { ...nd[i], type: e.target.value }; updateForm({ drains: nd }); }}>{DRAIN_TYPES.map(t => <option key={t} value={t}>{t}</option>)}</select>
                                                        </div>
                                                        <div><label className="text-[9px] font-bold text-orange-400 ml-1 uppercase">D√©bito</label>
                                                            <select className="w-full text-[11px] font-bold p-2 bg-white mt-1 border" value={d.debit} onChange={e => { const nd = [...editorData.drains]; nd[i] = { ...nd[i], debit: e.target.value }; updateForm({ drains: nd }); }}><option value="+">+</option><option value="-">-</option><option value="0">0</option></select>
                                                        </div>
                                                        <div><label className="text-[9px] font-bold text-orange-400 ml-1 uppercase">Aspecto</label>
                                                            <select className="w-full text-[11px] font-bold p-2 bg-white mt-1 border" value={d.char} onChange={e => { const nd = [...editorData.drains]; nd[i] = { ...nd[i], char: e.target.value }; updateForm({ drains: nd }); }}>{DRAIN_CHARS.map(c => <option key={c} value={c}>{c}</option>)}</select>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </Section>

                                        <div className="bg-iaf-light rounded-[2.5rem] border border-iaf-primary shadow-sm overflow-hidden mb-6">
                                            <div className="px-6 py-3 border-b border-white/50 flex items-center gap-2 bg-iaf-primary text-white font-black uppercase text-[10px] tracking-widest">
                                                <Icon name="plus" className="w-4 h-4" /> Anotaciones Finales
                                            </div>
                                            <div className="p-6">
                                                <textarea className="w-full bg-white p-6 h-40 rounded-[2rem] font-medium border-2 border-white/50 text-iaf-dark" value={editorData.notes || ''} onChange={e => updateForm({ notes: e.target.value })} placeholder="Resumen del turno y pendientes..." />
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="space-y-6 pb-32">
                                        <div className="bg-white p-8 rounded-[3.5rem] shadow-sm border border-iaf-gray">
                                            <div className="border-b border-iaf-gray pb-6 mb-6">
                                                <div className="flex flex-wrap items-center gap-3 mb-6">
                                                    <span className="text-3xl font-black text-iaf-primary uppercase tracking-tighter">{reportData.bed}</span>
                                                    <div className="h-6 w-px bg-gray-300 mx-2"></div>
                                                    <span className="text-xl font-bold text-iaf-dark uppercase tracking-tight">{reportData.name || "Sin nombre"}</span>
                                                    {reportData.hc && (
                                                        <>
                                                            <div className="h-5 w-px bg-gray-200 mx-1"></div>
                                                            <span className="px-3 py-1 bg-gray-100 rounded-lg text-xs font-black text-gray-500 uppercase tracking-wide">HC: {reportData.hc}</span>
                                                        </>
                                                    )}
                                                    {reportData.admissionDate && (
                                                        <>
                                                            <span className="px-3 py-1 bg-iaf-light text-iaf-primary rounded-lg text-xs font-black uppercase tracking-wide border border-iaf-primary">Ingreso: {reportData.admissionDate}</span>
                                                        </>
                                                    )}
                                                </div>
                                                
                                                {reportData.isolation?.type !== 'No' && (
                                                    <div className="mb-6 bg-red-50 border-2 border-red-100 p-4 rounded-3xl flex items-center gap-4 animate-in fade-in slide-in-from-top-2">
                                                        <div className="bg-red-500 text-white p-3 rounded-2xl shadow-sm">
                                                            <Icon name="shield" className="w-6 h-6" />
                                                        </div>
                                                        <div>
                                                            <p className="text-[10px] font-black text-red-500 uppercase tracking-widest leading-none mb-1">Precauci√≥n</p>
                                                            <p className="text-xl font-black text-red-900 uppercase leading-none">
                                                                Aislamiento {reportData.isolation?.type}
                                                            </p>
                                                            {reportData.isolation?.reason && (
                                                                <p className="text-sm font-bold text-red-700 mt-1 uppercase">
                                                                    Motivo: {reportData.isolation.reason}
                                                                </p>
                                                            )}
                                                        </div>
                                                    </div>
                                                )}

                                                <div className="space-y-4">
                                                    <div className="bg-gray-50 p-4 rounded-3xl border border-gray-100 relative overflow-hidden">
                                                        <div className="absolute top-0 left-0 w-1 h-full bg-gray-300"></div>
                                                        <p className="text-[10px] font-black text-gray-400 uppercase mb-1 ml-2">Antecedentes</p>
                                                        <p className="text-sm font-semibold text-iaf-dark leading-snug ml-2">{reportData.diagnosisBase || "---"}</p>
                                                    </div>
                                                    <div className="bg-iaf-light p-4 rounded-3xl border border-iaf-primary relative overflow-hidden">
                                                        <div className="absolute top-0 left-0 w-1 h-full bg-iaf-primary"></div>
                                                        <p className="text-[10px] font-black text-iaf-primary uppercase mb-1 ml-2">Motivo de Ingreso (Actual)</p>
                                                        <p className="text-lg font-black text-iaf-dark leading-tight uppercase tracking-tight ml-2">{reportData.diagnosisActive || "No definido"}</p>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                                                <div className="bg-cyan-50 p-6 rounded-3xl flex flex-col justify-center border border-cyan-100 shadow-sm relative overflow-hidden">
                                                    <div className="absolute top-right -mt-2 -mr-2 text-cyan-200/50"><Icon name="wind" className="w-24 h-24" /></div>
                                                    <p className="text-[10px] font-black text-cyan-600 uppercase mb-1 relative z-10">Respiratorio</p>
                                                    <p className="text-xl font-black text-cyan-900 leading-none uppercase relative z-10">{reportData.respiratory?.type}</p>
                                                    <div className="text-[11px] font-bold text-cyan-700 mt-3 uppercase flex flex-col gap-1 relative z-10">
                                                        { (reportData.respiratory?.type === "C√°nula Nasal" || reportData.respiratory?.type === "M√°scara Reservorio" || reportData.respiratory?.type === "M√°scara Simple") ? (
                                                            <span>FLUJO: {reportData.respiratory?.liters} L/MIN</span>
                                                        ) : (reportData.respiratory?.type === "ARM" || reportData.respiratory?.type === "VNI") ? (
                                                            <>
                                                                <span className="bg-white/50 px-2 py-0.5 rounded w-fit">MODALIDAD: {reportData.respiratory?.mode}</span>
                                                                <span>FiO2: {reportData.respiratory?.fio2}% | VT: {reportData.respiratory?.vt}ml</span>
                                                                <span>PEEP: {reportData.respiratory?.peep} | FR: {reportData.respiratory?.fr}</span>
                                                            </>
                                                        ) : (
                                                            <span>FiO2: {reportData.respiratory?.fio2}% | FLUJO: {reportData.respiratory?.liters}</span>
                                                        )}
                                                    </div>
                                                </div>

                                                <div className="bg-red-50 p-6 rounded-3xl flex flex-col justify-center border border-red-100 shadow-sm">
                                                    <p className="text-[10px] font-black text-red-600 uppercase mb-1">PHP / Ritmo</p>
                                                    <p className="text-2xl font-black text-red-900 leading-none mb-2">{reportData.medication?.php || "N/A"}</p>
                                                    <div className="border-t border-red-200 pt-2">
                                                        <p className="text-[9px] font-black text-indigo-400 uppercase mb-1">Alimentaci√≥n</p>
                                                        <p className="text-sm font-bold text-indigo-900 uppercase">{reportData.diet} {reportData.dietFlow && `(${reportData.dietFlow})`}</p>
                                                    </div>
                                                </div>
                                            </div>

                                            {(reportData.atbs || []).length > 0 && (
                                                <div className="mb-6 p-5 bg-amber-50 rounded-[2.5rem] border border-amber-100 shadow-sm">
                                                    <p className="text-[9px] font-black text-amber-600 uppercase mb-3 tracking-widest">Esquema Antibi√≥tico</p>
                                                    <div className="flex flex-wrap gap-2">
                                                        {reportData.atbs.map(a => (
                                                            <span key={a} className="px-4 py-1.5 bg-amber-600 text-white text-[10px] font-black rounded-xl shadow-sm border border-amber-500 uppercase">{a}</span>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}

                                            <div className="space-y-1 mb-8 pt-4 border-t border-gray-100">
                                                <p className="text-[9px] font-black text-gray-400 uppercase mb-2 tracking-widest ml-1">BIC y Paralelos</p>
                                                {reportData.medication?.infusions?.filter(i => i.drug).length > 0 ? (
                                                    reportData.medication.infusions.filter(i => i.drug).map((inf, i) => (
                                                        <div key={i} className="flex justify-between items-center p-3 border-b border-gray-50 last:border-0 hover:bg-gray-50 transition-colors">
                                                            <span className="text-sm font-bold text-iaf-dark uppercase italic tracking-tighter">{inf.drug}</span>
                                                            <span className="bg-red-600 text-white px-3 py-1 rounded-xl text-[10px] font-black shadow-sm">{inf.rate} ml/h</span>
                                                        </div>
                                                    ))
                                                ) : (
                                                    <p className="text-[10px] text-gray-300 italic ml-2">Sin paralelos activos</p>
                                                )}
                                            </div>

                                            {(reportData.vascular || []).length > 0 && (
                                                <div className="mb-6">
                                                     <p className="text-[9px] font-black text-pink-400 uppercase mb-2 tracking-widest ml-1">Accesos Vasculares</p>
                                                     <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                                        {reportData.vascular.map((v, i) => (
                                                            <div key={i} className="bg-pink-50 border border-pink-100 p-3 rounded-2xl flex items-center gap-3 shadow-sm">
                                                                <div className="bg-pink-200 p-2 rounded-xl text-pink-600">
                                                                    <Icon name="needle" className="w-4 h-4" />
                                                                </div>
                                                                <div>
                                                                    <p className="text-[10px] font-black text-pink-700 uppercase leading-none">{v.type}</p>
                                                                    <p className="text-[9px] font-bold text-gray-500 uppercase mt-1">{v.site}</p>
                                                                </div>
                                                            </div>
                                                        ))}
                                                     </div>
                                                </div>
                                            )}

                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 mt-4">
                                                <div className="bg-emerald-50/50 p-7 rounded-[2.5rem] border border-emerald-100 shadow-sm">
                                                    <p className="text-[10px] font-black text-emerald-600 uppercase mb-4 tracking-widest leading-none">Balance de Eliminaci√≥n</p>
                                                    <div className="space-y-5">
                                                        <div><p className="text-[11px] font-black text-iaf-dark uppercase leading-none">Diuresis: {reportData.elimination?.diuresisMethod}</p>
                                                            <p className="text-[10px] font-bold text-emerald-700 mt-1 uppercase italic leading-none">{reportData.elimination?.diuresisChar}</p>
                                                        </div>
                                                        <div className="pt-4 border-t border-emerald-100/50"><p className="text-[11px] font-black text-iaf-dark uppercase leading-none">Catarsis: {reportData.elimination?.catarsisStatus}</p>
                                                            <p className="text-[10px] font-bold text-emerald-700 mt-1 uppercase italic leading-none">{reportData.elimination?.catarsisChar}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="space-y-3">
                                                    <p className="text-[9px] font-black text-orange-400 uppercase tracking-widest ml-1">Dispositivos Quir√∫rgicos</p>
                                                    {(reportData.drains || []).map((d, i) => (
                                                        <div key={i} className="flex justify-between items-center p-4 bg-orange-50/30 rounded-2xl border border-orange-100">
                                                            <div className="text-[10px] font-black uppercase text-gray-500 leading-tight">Drenaje {i+1}:<br/><span className="text-iaf-dark text-[11px] font-black italic">{d.type}</span></div>
                                                            <div className="text-right"><p className="text-[10px] font-black text-orange-600 uppercase leading-none mb-1">{d.char}</p><p className="text-[10px] font-bold text-gray-400">D√âBITO: {d.debit}</p></div>
                                                        </div>
                                                    ))}
                                                    {(reportData.drains || []).length === 0 && <p className="text-[10px] text-gray-300 italic text-center py-6 border-2 border-dashed border-gray-100 rounded-[2rem]">Sin drenajes</p>}
                                                </div>
                                            </div>

                                            {(reportData.cultures || []).length > 0 && (
                                                <div className="mb-8 p-7 bg-indigo-50/50 rounded-[2.5rem] border border-indigo-100 shadow-sm">
                                                    <p className="text-[9px] font-black text-indigo-600 uppercase mb-4 tracking-widest">Cronolog√≠a de Cultivos</p>
                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-2">
                                                        {reportData.cultures.map(c => (
                                                            <div key={c.id} className="flex flex-col border-b border-indigo-100/50 pb-1 text-[11px] font-black uppercase text-iaf-dark">
                                                                <div className="flex justify-between">
                                                                    <span>{c.t}</span>
                                                                    <span className="text-indigo-600">{c.d}</span>
                                                                </div>
                                                                {c.r && <span className="text-[9px] text-indigo-400 font-bold ml-2">‚Ü≥ {c.r}</span>}
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}

                                            <div className="p-8 bg-iaf-primary text-white rounded-[3rem] shadow-2xl mt-10 relative overflow-hidden border-t-4 border-white">
                                                <div className="absolute top-0 right-0 w-48 h-48 bg-white/10 blur-[60px] rounded-full"></div>
                                                <p className="text-[10px] font-black text-iaf-light uppercase tracking-[0.4em] mb-4 text-center">Observaciones y Pendientes</p>
                                                <p className="text-sm font-medium leading-relaxed italic opacity-90 whitespace-pre-wrap text-white">{reportData.notes || "Sin anotaciones."}</p>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </main>

                    {/* Div oculto para renderizar el PDF completo */}
                    <div id="printable-content">
                        <FullShiftReport patients={patients} />
                    </div>

                    {showConfig && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-3xl p-6 max-w-lg w-full shadow-2xl border border-iaf-gray">
                                <h3 className="text-lg font-black text-iaf-dark uppercase mb-4 flex items-center gap-2">
                                    <Icon name="cog" className="w-6 h-6 text-iaf-primary" />
                                    Configuraci√≥n de Nube
                                </h3>
                                <p className="text-xs text-gray-500 mb-4 leading-relaxed">
                                    Para sincronizar datos entre dispositivos (PC, Celular), pega aqu√≠ el JSON de configuraci√≥n de tu proyecto Firebase.<br/>
                                    Si dejas esto vac√≠o, la app funcionar√° en modo <strong>Local (Offline)</strong> solo en este dispositivo.
                                </p>
                                <textarea 
                                    className="w-full h-40 bg-white p-3 rounded-xl border-2 border-gray-200 text-xs font-mono text-gray-600 mb-4 focus:border-iaf-primary focus:ring-2 focus:ring-pink-200 outline-none resize-none"
                                    placeholder='{ "apiKey": "...", "authDomain": "...", "projectId": "..." }'
                                    value={manualConfig}
                                    onChange={(e) => setManualConfig(e.target.value)}
                                />
                                <div className="flex gap-3 justify-end">
                                    <button onClick={clearManualConfig} className="px-4 py-2 rounded-xl text-xs font-bold text-red-500 hover:bg-red-50 transition-colors uppercase">
                                        Borrar / Modo Local
                                    </button>
                                    <button onClick={() => setShowConfig(false)} className="px-4 py-2 rounded-xl text-xs font-bold text-gray-500 hover:bg-gray-100 transition-colors uppercase">
                                        Cancelar
                                    </button>
                                    <button onClick={saveManualConfig} className="px-6 py-2 rounded-xl text-xs font-black text-white bg-iaf-primary hover:bg-[#961166] shadow-lg active:scale-95 transition-all uppercase flex items-center gap-2">
                                        <Icon name="check" className="w-4 h-4" /> Guardar y Conectar
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>